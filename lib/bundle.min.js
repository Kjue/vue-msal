"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Msal=require("msal"),classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}(),AuthenticationContext=function(){function e(i){var r=this;classCallCheck(this,e),this.config=i.config||{clientId:"your aad application client id",cacheLocation:"localStorage",tenant:null,redirectUri:"base uri for this application",graphScopes:["user.read"]},this.applicationConfig={auth:{clientId:this.config.clientId,redirectUri:this.config.redirectUri,authority:this.config.tenant?void 0:"https://login.microsoftonline.com/"+this.config.tenant},cache:{cacheLocation:this.config.cacheLocation},graphScopes:this.config.graphScopes?this.config.graphScopes:["user.read"]},this.requireAuthOnInitialize=i.requireAuthOnInitialize,this.msalContext=new Msal.UserAgentApplication(this.applicationConfig),this.msalContext.handleRedirectCallback(this.authRedirectCallback),this.requireAuthOnInitialize&&(this.acquireToken(i.config.clientId,function(e,t){e&&console.log("Could not get token")}),this.config.graphScopes&&Object.keys(this.config.graphScopes).forEach(function(e,t){var n=this.config.graphScopes[e];this.acquireToken(n,function(e,t){e&&console.log("Could not get token")})})),i.router&&i.router.beforeEach(function(e,t,n){if(i.globalAuth||e.matched.some(function(e){return e.meta.requireAuth}))if(r.isAuthenticated()){var o=[];e.matched.some(function(e){return!!e.meta.requireRoles&&(o=o.concat(e.meta.requireRoles),!0)})?r.checkRoles(o)?n():(console.log("Not Authorized"),n(t.fullPath)):n()}else r.login();else n()})}return createClass(e,[{key:"authRedirectCallback",value:function(e,t){e&&console.error(e),t&&console.log(t)}},{key:"authResponseCallback",value:function(e,t){e&&console.error(e),t&&console.log(t)}},{key:"login",value:function(){this.acquireToken()}},{key:"logout",value:function(){this.msalContext.logOut()}},{key:"acquireToken",value:function(e,t){var n=this,o=this;return this.msalContext.acquireTokenSilent({scopes:this.applicationConfig.graphScopes,account:this.applicationConfig.auth.clientId}).then(function(e){o.user=e.account,t&&t(null,e.accessToken)},function(e){return console.log(e),o.msalContext.loginPopup({account:n.applicationConfig.auth.clientId}).then(function(e){o.user=e.account,t&&t(null,e.accessToken)},function(e){t?t(e):console.error(e)})})}},{key:"acquireTokenRedirect",value:function(e,t){this.msalContext.acquireTokenRedirect(e,t)}},{key:"getResourceForEndpoint",value:function(e){return this.msalContext.getScopesForEndpoint(e)}},{key:"isAuthenticated",value:function(){return!!this.msalContext.getAccount()}},{key:"checkRoles",value:function(e){if(!this.isAuthenticated())return!1;var t=this.msalContext.getAccount();if(!t||!t.idToken||!t.idToken.roles)return!1;"string"==typeof e&&(e=[e]);for(var n=0;n<e.length;n++)if(-1<t.idToken.roles.indexOf(e[n]))return!0;return!1}},{key:"clearCacheForScope",value:function(e){if(!this.isAuthenticated())return!1;this.msalContext.clearCacheForScope(e)}}]),e}(),getToken=function(n,o,i){AuthenticationContext.acquireToken(n,function(e,t){if(e){switch(e.split(":")[0]){case"AADSTS50058":AuthenticationContext.login();break;case"AADSTS65001":AuthenticationContext.acquireTokenRedirect(n);break;case"AADSTS16000":default:AuthenticationContext.login()}i(new Error("Failed to acquire token"))}else o.defaults.headers.Authorization="BEARER "+t,i(null,t)})},AxiosAuthHttp=function(){function e(){classCallCheck(this,e)}return createClass(e,null,[{key:"createNewClient",value:function(i){if(null==i)throw new Error("Provided options for auth-http are null!");if(null==i.axios)throw new Error("options.axios is required to generate a new http client");if(null==i.resourceId)throw new Error("options.resourceId is required to acquire an auth token");var r=i.axios.create({baseURL:i.baseUrl,headers:{Authorization:null}});return r.interceptors.response.use(function(e){return e},function(o){return 401===o.response.status?(AuthenticationContext.clearCacheForScope(i.resourceId),new Promise(function(t,n){return getToken(i.resourceId,r,function(){var e=o.response.config;e.headers.Authorization=r.defaults.headers.Authorization,r({method:e.method,url:e.url,data:e.data,headers:{Accept:e.headers.Accept,Authorization:e.headers.Authorization,"Content-Type":e.headers["Content-Type"]}}).then(function(e){return t(e)},function(e){return n(e)})})})):Promise.reject(o)}),null==i.router||i.router.beforeEach(function(e,t,n){getToken(i.resourceId,r,function(e,t){if(e)return i.onTokenFailure instanceof Function&&i.onTokenFailure(e),void n();i.onTokenSuccess instanceof Function&&i.onTokenSuccess(r,AuthenticationContext,t),n()})}),r}}]),e}();exports.AuthenticationContext=null;var MsalPlugin={install:function(e,t){var n=1<arguments.length&&void 0!==t?t:{};exports.AuthenticationContext=new AuthenticationContext(n),e.prototype.$msal=exports.AuthenticationContext,e.mixin({data:function(){return{authenticated:!1}},computed:{isAuthenticated:function(){return this.authenticated=this.$msal.isAuthenticated(),this.authenticated}}})}};exports.default=MsalPlugin,exports.AxiosAuthHttp=AxiosAuthHttp;